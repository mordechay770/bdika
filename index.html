<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>מעקב שתייה</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial;
    background: #eef2f7;
    margin: 0;
    padding: 20px;
    text-align: center;
}

h1 { font-size: 34px; }
h2 { color: #444; }

#cups {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

.cup {
    width: 60px;
    height: 120px;
    border: 3px solid #333;
    border-radius: 0 0 15px 15px;
    position: relative;
    overflow: hidden;
    background: #fff;
}

.water {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: #4da6ff;
    transition: height 0.4s;
}

.cup-label {
    margin-top: 5px;
    font-size: 14px;
}

.buttons button {
    font-size: 22px;
    padding: 15px 25px;
    margin: 10px;
    border-radius: 12px;
    border: none;
    color: white;
    cursor: pointer;
}

.btn25 { background:#9cc9ff; }
.btn50 { background:#6aaeff; }
.btn100 { background:#2d7dff; }
.btn200 { background:#004fc5; }

.history {
    margin-top: 20px;
    text-align: right;
}

.history div {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #ccc;
    padding: 6px 0;
}

.delete {
    color: red;
    cursor: pointer;
}
</style>
</head>

<body>

<h1 id="title">טוען...</h1>
<h2 id="subtitle"></h2>
<div id="time"></div>

<div id="cups"></div>

<div class="buttons">
    <button class="btn25" onclick="sendDrink(25)">+25</button>
    <button class="btn50" onclick="sendDrink(50)">+50</button>
    <button class="btn100" onclick="sendDrink(100)">+100</button>
    <button class="btn200" onclick="sendDrink(200)">+200</button>
</div>

<div class="history" id="history"></div>

<script>
const FETCH_WEBHOOK = "https://hook.integrator.boost.space/n33w53hpsj1ar34x25b9psqwx8sbcj0n";
const ACTION_WEBHOOK = "https://hook.integrator.boost.space/uhlqmxm4tzn2rpy04qga5lcip6o5rnbs";


let locked = false;

function loadData() {
    fetch(FETCH_WEBHOOK + "?t=" + Date.now())
        .then(r => r.json())
        .then(data => {
            document.getElementById("title").innerText = data.title;
            document.getElementById("subtitle").innerText = data.subtitle;
            drawCups(data.totalDrank, data.dailyLimit);
            drawHistory(data.history);
            updateClock();
        });
}

function drawCups(total, limit) {
    const cups = document.getElementById("cups");
    cups.innerHTML = "";

    const cupSize = 200;
    const totalCups = Math.ceil(limit / cupSize);

    for (let i = 1; i <= totalCups; i++) {
        const filled = Math.max(0, Math.min(1, (total - (i-1)*cupSize) / cupSize));

        const cup = document.createElement("div");
        cup.className = "cup";

        const water = document.createElement("div");
        water.className = "water";
        water.style.height = (filled * 100) + "%";

        cup.appendChild(water);

        const label = document.createElement("div");
        label.className = "cup-label";
        label.innerText = "200 מ״ל";

        const wrapper = document.createElement("div");
        wrapper.appendChild(cup);
        wrapper.appendChild(label);

        cups.appendChild(wrapper);
    }
}

function sendDrink(amount) {
    if (locked) return;
    locked = true;

    fetch(ACTION_WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            action: "add",
            amount,
            timestamp: new Date().toISOString()
        })
    }).then(() => {
        setTimeout(() => {
            locked = false;
            loadData();
        }, 1200);
    });
}

function drawHistory(list) {
    const box = document.getElementById("history");
    box.innerHTML = "";

    list.forEach(row => {
        const div = document.createElement("div");
        div.innerHTML = `
            <span>${row.time} – ${row.amount} מ״ל</span>
            <span class="delete" onclick="deleteRow('${row.record_id}')">❌</span>
        `;
        box.appendChild(div);
    });
}

function deleteRow(id) {
    if (!confirm("למחוק את הדיווח?")) return;

    fetch(ACTION_WEBHOOK, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            action: "delete",
            record_id: id
        })
    }).then(loadData);
}

function updateClock() {
    const now = new Date();
    document.getElementById("time").innerText =
        now.toLocaleDateString("he-IL") + " | " +
        now.toLocaleTimeString("he-IL");
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
